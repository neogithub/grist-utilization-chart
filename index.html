<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Grist Test</title>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
</head>
<body>
    <h1>Grist Connection Test</h1>
    <div id="status"></div>

    <script>
        // Update status function
        function updateStatus(message) {
            document.getElementById('status').innerHTML += "<br>" + new Date().toISOString() + ": " + message;
        }

        // Initial status
        updateStatus("Page loaded");

        // Async function to handle Grist initialization
        async function initGrist() {
            try {
                updateStatus("Attempting to initialize Grist...");
                
                // Wait for Grist API to be ready
                await grist.ready();
                updateStatus("Grist initialized successfully");

                // Set up the record subscription
                grist.onRecords(function(records) {
                    updateStatus("Received records from Grist: " + records.length);
                    if (records && records.length > 0) {
                        updateStatus("Sample record: " + JSON.stringify(records[0]));
                    }
                });

                // Test table access
                const tableId = await grist.selectedTable.getTableId();
                updateStatus("Connected to table: " + tableId);

            } catch (error) {
                updateStatus("ERROR: " + error.message);
                console.error(error);
            }
        }

        // Check if grist is defined
        if (typeof grist === 'undefined') {
            updateStatus("ERROR: Grist API not found!");
        } else {
            updateStatus("Grist API found, initializing...");
            initGrist().catch(err => {
                updateStatus("ERROR in initialization: " + err.message);
            });
        }

        // Add error handler
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            updateStatus("GLOBAL ERROR: " + msg);
            return false;
        };
    </script>
</body>
</html>