<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Utilization Chart</title>
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 16px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    select {
      margin: 5px;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      min-width: 120px;
    }
    .filters {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
    }
    .chart-container {
      position: relative;
      height: 400px;
      width: 100%;
    }
    #status {
      padding: 10px;
      margin-bottom: 10px;
      background-color: #f8f9fa;
      border-radius: 4px;
      white-space: pre-wrap;
      font-family: monospace;
    }
    #debug {
      padding: 10px;
      margin-top: 10px;
      background-color: #f5f5f5;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div id="status">Initializing...</div>
  <div class="filters">
    <select id="yearFilter">
      <option value="all">All Years</option>
    </select>
    <select id="quarterFilter">
      <option value="all">All Quarters</option>
    </select>
    <select id="departmentFilter">
      <option value="all">All Departments</option>
    </select>
  </div>
  <div class="chart-container">
    <canvas id="utilizationChart"></canvas>
  </div>
  <div id="debug"></div>

  <script>
    function log(message, data) {
      const debug = document.getElementById('debug');
      const time = new Date().toISOString();
      debug.innerHTML += `[${time}] ${message}\n${JSON.stringify(data, null, 2)}\n\n`;
      console.log(message, data);
    }

    function updateStatus(message) {
      document.getElementById('status').textContent = message;
      console.log('Status:', message);
    }

    let chart = null;

    function initializeChart(data) {
      const ctx = document.getElementById('utilizationChart').getContext('2d');
      
      if (chart) {
        chart.destroy();
      }

      chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.map(d => d.name),
          datasets: [
            {
              label: 'Billable %',
              data: data.map(d => d.billable),
              backgroundColor: '#4CAF50',
            },
            {
              label: 'Non-Billable %',
              data: data.map(d => d.nonBillable),
              backgroundColor: '#FF9800',
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              stacked: false
            },
            x: {
              stacked: false
            }
          }
        }
      });
    }

    function updateFilters(records) {
      log('Updating filters with records', { 
        recordCount: records.length,
        sampleRecord: records[0]
      });

      const years = [...new Set(records.map(r => r[0]))].sort();
      const quarters = [...new Set(records.map(r => r[1]))].sort();
      const departments = [...new Set(records.map(r => r[3]))].sort();

      log('Extracted unique values', { years, quarters, departments });

      const yearFilter = document.getElementById('yearFilter');
      const quarterFilter = document.getElementById('quarterFilter');
      const departmentFilter = document.getElementById('departmentFilter');

      // Clear existing options except "All"
      yearFilter.innerHTML = '<option value="all">All Years</option>';
      quarterFilter.innerHTML = '<option value="all">All Quarters</option>';
      departmentFilter.innerHTML = '<option value="all">All Departments</option>';

      // Add new options
      years.forEach(year => {
        const opt = new Option(year, year);
        yearFilter.add(opt);
        log('Added year option', { year });
      });
      
      quarters.forEach(quarter => {
        const opt = new Option(quarter, quarter);
        quarterFilter.add(opt);
        log('Added quarter option', { quarter });
      });
      
      departments.forEach(dept => {
        const opt = new Option(dept, dept);
        departmentFilter.add(opt);
        log('Added department option', { dept });
      });
    }

    function processData(records) {
      const yearFilter = document.getElementById('yearFilter').value;
      const quarterFilter = document.getElementById('quarterFilter').value;
      const departmentFilter = document.getElementById('departmentFilter').value;

      log('Processing data with filters', {
        yearFilter,
        quarterFilter,
        departmentFilter,
        recordCount: records.length
      });

      let filtered = records;
      
      if (yearFilter !== 'all') {
        filtered = filtered.filter(r => r[0] === parseInt(yearFilter));
      }
      if (quarterFilter !== 'all') {
        filtered = filtered.filter(r => r[1] === quarterFilter);
      }
      if (departmentFilter !== 'all') {
        filtered = filtered.filter(r => r[3] === departmentFilter);
      }

      log('After filtering', { filteredCount: filtered.length });

      const processed = _.map(
        _.groupBy(filtered, r => r[2]), // Group by Name
        (group, name) => ({
          name,
          department: group[0][3],
          billable: _.meanBy(group, r => r[4]),
          nonBillable: _.meanBy(group, r => r[5])
        })
      );

      log('Processed data', { 
        processedCount: processed.length,
        sampleProcessed: processed[0] 
      });

      initializeChart(processed);
    }

    // Initialize Grist
    grist.ready({
      requiredAccess: 'read'
    }).then(() => {
      log('Grist ready called');
    }).catch(err => {
      log('Error in grist.ready', { error: err.message });
    });

    // Set up event listeners
    document.getElementById('yearFilter').addEventListener('change', () => {
      grist.onRecords(records => processData(records));
    });
    document.getElementById('quarterFilter').addEventListener('change', () => {
      grist.onRecords(records => processData(records));
    });
    document.getElementById('departmentFilter').addEventListener('change', () => {
      grist.onRecords(records => processData(records));
    });

    // Subscribe to Grist data
    grist.onRecords(records => {
      log('Received records from Grist', { 
        count: records.length,
        sampleRecord: records[0] 
      });

      if (!records || !records.length) {
        updateStatus('No data available');
        return;
      }

      updateFilters(records);
      processData(records);
      updateStatus('Chart ready');
    });
  </script>
</body>
</html>