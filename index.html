<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Utilization Chart</title>
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/2.1.0/chartjs-plugin-annotation.min.js"></script>
  <style>
    /* Previous styles remain the same */
  </style>
</head>
<body>
  <div id="status">Initializing...</div>
  <div id="debug" style="font-family: monospace; font-size: 12px; padding: 10px; background: #f5f5f5; margin-bottom: 10px;"></div>
  <div class="view-controls">
    <button id="barView" class="active">Bar Chart</button>
    <button id="trendView">Trend Analysis</button>
    <div class="checkbox-wrapper">
      <input type="checkbox" id="showTarget" checked>
      <label for="showTarget">Show Target</label>
    </div>
  </div>
  <div class="filters">
    <!-- Previous filters remain the same -->
  </div>
  <div class="chart-container">
    <canvas id="utilizationChart"></canvas>
  </div>

  <script>
    // Register the annotation plugin
    Chart.register(ChartJS.Annotation);

    function debug(msg, data) {
      const debugDiv = document.getElementById('debug');
      debugDiv.innerHTML = `${msg}: ${JSON.stringify(data, null, 2)}`;
      console.log(msg, data);
    }

    function createBarChart(data) {
      const ctx = document.getElementById('utilizationChart').getContext('2d');
      
      if (chart) {
        chart.destroy();
      }

      debug('Creating bar chart with data', {
        showTarget,
        sampleData: data[0],
        totalRecords: data.length
      });

      const annotations = {};
      if (showTarget) {
        annotations.annotations = data.map((d, index) => ({
          type: 'line',
          yMin: d.target,
          yMax: d.target,
          xMin: index - 0.35,
          xMax: index + 0.35,
          borderColor: 'red',
          borderWidth: 2,
          borderDash: [5, 5],
          label: {
            enabled: true,
            content: `Target: ${d.target}%`,
            position: 'start'
          }
        }));
      }

      chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.map(d => d.name.trim()),
          datasets: [
            {
              label: 'Billable %',
              data: data.map(d => d.billable),
              backgroundColor: '#4CAF50',
            },
            {
              label: 'Non-Billable %',
              data: data.map(d => d.nonBillable),
              backgroundColor: '#FF9800',
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              stacked: false,
              max: 100
            },
            x: {
              stacked: false
            }
          },
          plugins: {
            annotation: annotations
          }
        }
      });
    }

    function createTrendChart(records) {
      const ctx = document.getElementById('utilizationChart').getContext('2d');
      
      if (chart) {
        chart.destroy();
      }

      debug('Creating trend chart with records', {
        showTarget,
        sampleRecord: records[0],
        totalRecords: records.length
      });

      const sortedRecords = _.sortBy(records, [
        r => r.Year,
        r => r.Quarter.substring(1)
      ]);

      const labels = sortedRecords.map(r => `${r.Year} ${r.Quarter}`);
      const billableData = sortedRecords.map(r => r.Billable);
      const target = sortedRecords[0]?.Target;

      const datasets = [{
        label: 'Billable % Trend',
        data: billableData,
        borderColor: '#4CAF50',
        backgroundColor: 'rgba(76, 175, 80, 0.1)',
        tension: 0.1,
        fill: true
      }];

      const annotations = {};
      if (showTarget && target) {
        datasets.push({
          label: 'Target %',
          data: Array(labels.length).fill(target),
          borderColor: 'red',
          borderWidth: 2,
          borderDash: [5, 5],
          fill: false,
          pointRadius: 0
        });

        annotations.annotations = {
          targetLine: {
            type: 'line',
            yMin: target,
            yMax: target,
            borderColor: 'red',
            borderWidth: 2,
            borderDash: [5, 5],
            label: {
              enabled: true,
              content: `Target: ${target}%`,
              position: 'start'
            }
          }
        };
      }

      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              title: {
                display: true,
                text: 'Billable %'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Time Period'
              }
            }
          },
          plugins: {
            annotation: annotations
          }
        }
      });
    }

    function processData(records) {
      let filtered = records;
      
      if (currentFilters.year !== 'all') {
        filtered = filtered.filter(r => r.Year === parseInt(currentFilters.year));
      }
      if (currentFilters.quarter !== 'all') {
        filtered = filtered.filter(r => r.Quarter === currentFilters.quarter);
      }
      if (currentFilters.department !== 'all') {
        filtered = filtered.filter(r => r.Department === currentFilters.department);
      }
      if (currentFilters.name !== 'all') {
        filtered = filtered.filter(r => r.Name.trim() === currentFilters.name);
      }

      debug('Processing filtered data', {
        originalCount: records.length,
        filteredCount: filtered.length,
        filters: currentFilters,
        sampleRecord: filtered[0]
      });

      if (currentView === 'bar') {
        const processed = _.map(
          _.groupBy(filtered, r => r.Name),
          (group, name) => ({
            name,
            department: group[0].Department,
            billable: _.meanBy(group, r => r.Billable),
            nonBillable: _.meanBy(group, r => r.Non_Billable),
            target: group[0].Target
          })
        );
        createBarChart(processed);
      } else {
        createTrendChart(filtered);
      }
    }

    // Initialize Grist
    grist.ready();
    
    // Set up event listeners for filters
    ['year', 'quarter', 'department', 'name'].forEach(filterId => {
      document.getElementById(filterId + 'Filter').addEventListener('change', (e) => {
        currentFilters[filterId] = e.target.value;
        processData(currentRecords);
      });
    });

    // Set up view toggle listeners
    document.getElementById('barView').addEventListener('click', (e) => {
      currentView = 'bar';
      document.getElementById('barView').classList.add('active');
      document.getElementById('trendView').classList.remove('active');
      processData(currentRecords);
    });

    document.getElementById('trendView').addEventListener('click', (e) => {
      currentView = 'trend';
      document.getElementById('trendView').classList.add('active');
      document.getElementById('barView').classList.remove('active');
      processData(currentRecords);
    });

    // Target toggle listener
    document.getElementById('showTarget').addEventListener('change', (e) => {
      showTarget = e.target.checked;
      processData(currentRecords);
    });

    // Subscribe to Grist data
    grist.onRecords(records => {
      if (!records || !records.length) {
        updateStatus('No data available');
        return;
      }

      currentRecords = records;
      updateFilters(records);
      processData(records);
      updateStatus('Chart ready');
    });
  </script>
</body>
</html>